<tool id="geec" name="GeEC Matrix">
  <description>creates a correlation matrix between many datasets [v0.5]</description>
  <command interpreter="python">
    geec.py
    --bigwigs
    #for i in $userData
      $i
    #end for
    --labels
    #for i in $userData
      $i.name
    #end for
    --md5s
    $ihecdata
    --include
    $cond.include
    --exclude
    $cond.exclude
    --bin
    $cond.resolution
    --output
    $output
    --assembly
    $cond.assembly
    --metric
    $metric
  </command>
  <requirements>
    <requirement type="package" version="0.1.0">geec</requirement>
  </requirements>
  <inputs>
    <param format="bigwig" name="userData" type="data" label="User's dataset(s)" optional="true" multiple="true" help="Formats currently supported: BigWig"/>
    
    <param format="json" name="ihecdata" type="data" label="Selected public datasets metadata" optional="true" multiple="false" help='A file imported from the "GeEC Public Datasets" selection tool and containing public dataset metadata in json format'/>

    <conditional name="cond">
      <param name="assembly" type="select" label="Assembly" help="Select the assembly matching your input data">
        <option value="hg19" selected="true">hg19</option>
        <option value="hg38">hg38</option>
        <option value="mm10">mm10</option>
      </param>

      <when value="hg19">
        <param name="resolution" type="select" label="Resolution of the comparison" help="Datasets are binned at this resolution before applying next parameters">
          <option value="1000">1000</option>
          <option value="10000" selected="true">10000</option>
        </param>

        <param name="include" type="select" label="Selection regions" help="The comparison will only involve bins overlapping these regions">
          <option value="all" selected="true">Whole genome</option>
        </param>

        <param name="exclude" type="select" label="Exclusion regions" help="The comparison will exclude bins overlapping these regions">
          <option value="blklst" selected="true">Blacklisted</option>
          <option value="none">None</option>
        </param>
      </when>

      <when value="hg38">
        <param name="resolution" type="select" label="Resolution of the comparison" help="Datasets are binned at this resolution before applying next parameters">
          <option value="1000">1000</option>
          <option value="10000" selected="true">10000</option>
        </param>

        <param name="include" type="select" label="Selection regions" help="The comparison will only involve bins overlapping these regions">
          <option value="all" selected="true">Whole genome</option>
        </param>

        <param name="exclude" type="select" label="Exclusion regions" help="The comparison will exclude bins overlapping these regions">
          <option value="none" selected="true">None</option>
        </param>
      </when>

      <when value="mm10">
        <param name="resolution" type="select" label="Resolution of the comparison" help="Datasets are binned at this resolution before applying next parameters">
          <option value="1000">1000</option>
          <option value="10000" selected="true">10000</option>
        </param>

        <param name="include" type="select" label="Selection regions" help="The comparison will only involve bins overlapping these regions">
          <option value="all" selected="true">Whole genome</option>
        </param>

        <param name="exclude" type="select" label="Exclusion regions" help="The comparison will exclude bins overlapping these regions">
          <option value="blklst" selected="true">Blacklisted</option>
          <option value="none">None</option>
        </param>
      </when>

      <when value="sacCer3">
        <param name="resolution" type="select" label="Resolution of the comparison" help="Datasets are binned at this resolution before applying next parameters">
          <option value="1000" selected="true">1000</option>
        </param>

        <param name="include" type="select" label="Selection regions" help="The comparison will only involve bins overlapping these regions">
          <option value="all" selected="true">Whole genome</option>
        </param>

        <param name="exclude" type="select" label="Exclusion regions" help="The comparison will exclude bins overlapping these regions">
          <option value="none" selected="true">None</option>
        </param>
      </when>

    </conditional>

    <param name="metric" type="select" label="Correlation metric">
      <option value="pearson" selected="true">Pearson</option>
      <option value="spearman">Spearman</option>
    </param>

  </inputs>
  <outputs>
    <data format="tabular" name="output" />
  </outputs>

<help>
**What it does**


GeEC Matrix takes as input a json file from the "GeEC Public Datasets" tool. Those files contain the metadata of the selected public datasets, including their md5sum. The list of md5sum is used to reach the pre-calculated internal hdf5 files of the public datasets (generated at the given resolution, with the appropriate selection and exclusion filters, and using the selected metric). The large public datasets are therefore not transferred to the user’s history.

A user can also select datasets from his history, which will then be processed based on the selected options, then compared to the public datasets. It is actually possible to run GeEC Matrix strictly on private datasets (without public datasets). The assembly option is used to select the appropriate chromSizes file to internally generate the hdf5 files. 
The output of GeEC Matrix is a tsv file containing the correlation matrix calculated on the canonical chromosomes and using a concatenation of the filename and the md5sum as column/line identifiers.

It is recommended to next use “GeEC Annotate” to create a heatmap with its dendrogram as well as a multidimensional scaling representation of the matrix, and even to cluster the datasets and annotate these clusters with the provided metadata.
</help>

</tool>
